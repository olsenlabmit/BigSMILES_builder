<!doctype html>
<!-- The DOCTYPE declaration above will set the     -->
<!-- browser's rendering engine into                -->
<!-- "Standards Mode". Replacing this declaration   -->
<!-- with a "Quirks Mode" doctype is not supported. -->

<html style="">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <!--                                           -->
    <title>BigSMILES Builder</title>
    <link rel="shortcut icon" type="image/png" href="favicon.ico"/>
    <script src="jquery/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" language="javascript" src="jsme/jsme.nocache.js"></script>
    <script>
    //this function will be called after the JavaScriptApplet code has been loaded.
    function jsmeOnLoad() {
      // initialize JSME editor with styrene repeat unit
      var startingStructure = "10 10 $ 10.30 -8.40 C 11.52 -7.70 C 12.73 -8.40 $ 13.94 -7.70 C 12.73 -9.80 C 11.52 -10.50 C 11.52 -11.90 C 12.73 -12.60 C 13.94 -11.90 C 13.94 -10.50 1 2 1 2 3 1 3 4 1 3 5 1 6 7 1 7 8 2 8 9 1 9 10 2 5 10 1 5 6 2";
    	//var startingStructure = "10 10 $ 10.30 -8.40 Z 11.52 -7.70 C 12.73 -8.40 $ 13.94 -7.70 C 12.73 -9.80 C 11.52 -10.50 C 11.52 -11.90 C 12.73 -12.60 C 13.94 -11.90 C 13.94 -10.50 1 2 1 2 3 1 3 4 1 3 5 1 6 7 1 7 8 2 8 9 1 9 10 2 5 10 1 5 6 2";
    	//Instantiate a new JSME:
    	//arguments: HTML id, width, height (must be string not number!)
     	jsmeApplet = new JSApplet.JSME("appletContainer", "600px", "440px", {
     		//optional parameters
     		"options" : "number,query,hydrogens",
     		"jme" : startingStructure
     	});
    	//One can mimic the JME Java applet access to simplify the adaptation of HTML and JavaScript code:
    	document.JME = jsmeApplet;
      jsmeApplet.setMolecularAreaScale(1.5);
      jsmeApplet.setMenuScale(1.5);
    }
    </script>

    <style>
      .redSpan {color:red;}
      .textBox {margin-left: 5px;width:590px;resize: none;}
      #JSMEcite {font-size: 14px;float:right;margin-right: 10px;}
      #displayPanel {top:0px;height:100%;position:fixed;border:1;padding: 10px;background: white;overflow: scroll;}
      #BigSMILEScontainer {width:650px;top: 0px;left:670px;position:relative;background: white;max-width:650px;}
      #rootPolymer {float:left;background: white;border:none;margin-top: 0px;}
      #rootPolymer h2 {margin-bottom:0.1em;margin-top: 0;}

      .Polymer {border:1px none;max-width:650px;float:left;background: none;display:none;
                margin-left:30px;position:relative;top:-10px;margin-top:15px;}
      .Polymer .title {margin-bottom:0.1em;margin-top: 1em;}
      .PolymerColoredSMILES {margin:10px;}
      .PolymerSMILES {display: none;}
      .PolymerHidden {display: none;}
      .PolymerSVG {border:solid 1px;width:600px;,margin-bottom:10px;}

      .StoObj {border:1px none;max-width:650px;float:left;background: white;display:none;
               margin-left:30px;margin-top: 15px;}
      .StoObj .title {margin-bottom:0em;margin-top:0em;}
      .RepeatUnit {border:1px red none;display:block;
                   margin-left:10px;margin-bottom:10px;margin-top:10px;}
      .RepeatUnit h2 {margin-bottom:0.1em;margin-top:1em;}
      .count {display:none;}
      .EndGroup {border:1px red none;display:block;margin:10px;margin-top:20px;}

      .DescText {margin-left: 10px;}
      .DescText input {margin-left: 0px;margin-right:5px;}
      .leftEnd {display: none;}
      .rightEnd {display: none;}
    </style>

  </head>

  <body style="">


    <!-- RECOMMENDED if your web app will not function without JavaScript enabled -->
    <noscript>
      <div style="width: 22em; position: absolute; left: 50%; margin-left: -11em; color: red; background-color: white; border: 1px solid red; padding: 4px; font-family: sans-serif">
        Your web browser must have JavaScript enabled
        in order for this application to display correctly.
      </div>
    </noscript>



    <div id="displayPanel">
      <table align="left" style="border:solid;">
        <tr>
          <td id="appletContainer"></td>
        </tr>
        <tr><td><span id="JSMEcite">BigSMILES Builder is powered by the <a href="https://peter-ertl.com/jsme/" target="_blank">JSME Molecular Editor</a></span></td></tr>
        <tr><td>&nbsp;</td></tr>
        <tr><td>BigSMILES String <button type="button" class="getStr">Get String</button></td></tr>
        <tr>
          <td><textarea id="BigSmiles" class="textBox" cols=60 rows=2>BigSMILES representation here!</textarea>
        </tr>
        <tr><td>Error Messages</td></tr>
        <tr>
          <td><textarea id="ErrMsg" class="textBox" cols=60 rows=5></textarea>
        </tr>
      </table>
    </div>


    <div id="BigSMILEScontainer">
      <h1>BigSMILES Builder</h1>

      <div id="PolymerTemplate" class="Polymer">
        <h2 class="title">BigSMILES Unit: <span class="address"></span></h2>
        <button class="gen" type="button">Import from Editor</button>
        <button class="proj" type="button">Project to Editor</button>
        <button class="clear" type="button">Clear Polymer</button>

        <div class="PolymerColoredSMILES"></div>
        <div class="PolymerSMILES"></div>
        <div class="PolymerHidden"></div>
        <div class="PolymerSVG"></div>
      </div>

      <div id="StoObjTemplate" class="StoObj">
        <h2 class="title">Stochastic Object: <span class="address">1</span></h2>
        <span class="DescText">Bond Descriptors:
          Left: <input type="text" size=4 class="leftDesc" />
          Right: <input type="text" size=4 class="rightDesc" />
          <span class="leftEnd">0</span><span class="rightEnd">0</span>
        </span>
        <div class="RepeatUnit">
          <h2>Repeat Units</h2>
          <div class="count">0</div>
          <button class="addUnit" type="button">Add Repeat Unit</button>
          <button class="delUnit" type="button">Delete Last Repeat Unit</button>
        </div>
        <div class="EndGroup">
          <h2 style="margin-bottom:0.1em;">End Groups</h2>
          <div class="count">0</div>
          <button class="addUnit" type="button">Add End Group</button>
          <button class="delUnit" type="button">Delete End Group</button>
        </div>
      </div>

      <div id="rootPolymer">
        <h2>Base Polymer: <span class="address">/</span></h2>
        <button class="gen" type="button">Import from Editor</button>
        <button class="proj" type="button">Project to Editor</button>
        <button class="clear" type="button">Clear Polymer</button>
        <div class="PolymerColoredSMILES"></div>
        <div class="PolymerSMILES"></div>
        <div class="PolymerHidden"></div>
        <div class="PolymerSVG"></div>
      </div>

    </div> <!-- BigSMILEScontainer -->

    <script>
      var stoObjPatt = /\[Z\:?[0-9]*\]/ig;
      //var bondDesc = /\[([$<>][\-\=\/\\\#\:]?(\%[0-9][0-9]|[0-9])?)(\:[0-9]+)?\]/g;
      var bondDescPatt = /\[([$<>][\-\=\/\\\#\:]?(\%[0-9][0-9]|[0-9])?)\]/g;

      $( "#BigSMILEScontainer" ).on("click",'.delUnit',function( event ) {
        var divElement = $(this).parent();
        var unitIdx = parseInt(divElement.children(".count").html());
        if(unitIdx < 1) {
          return;
        } else {
          // remove element
          divElement.children(".Polymer").eq(unitIdx-1).remove();
          // reset counter
          divElement.children(".count").html(String(unitIdx-1));
        }
      });

      $( "#BigSMILEScontainer" ).on("click",'.addUnit',function( event ) {
        var divElement = $(this).parent();
        var unitIdx = parseInt(divElement.children(".count").html())+1;
        divElement.children(".count").html(String(unitIdx));
        if($(this).html() == "Add Repeat Unit") {
          newIdx = divElement.parent().children().children(".address").html()+'-'+String(unitIdx)+'/';
        }
        else {
          newIdx = divElement.parent().children().children(".address").html()+'-E'+String(unitIdx)+'/';
        }

        newElement = $("#PolymerTemplate").clone();
        newElement.css("display","block");
        newElement.children().children(".address").html(newIdx);
        newElement.appendTo(divElement);
      });


      $( "#BigSMILEScontainer" ).on("click",'.gen',function( event ) {
        // get container
        var divElement = $(this).parent();
        // clear existing Polymer
        clearPolymer(divElement);
        // get representation from JSME editor
        var smilesStr = correctBondDesc(document.JME.smiles());
        var coloredSmilesStr = highlightStoObj(smilesStr);
        divElement.children(".PolymerSMILES").html(smilesStr);
        divElement.children(".PolymerColoredSMILES").html(coloredSmilesStr);
        var jmeStr = document.JME.jmeFile();
        divElement.children(".PolymerHidden").html(jmeStr);
        var svgStr = jsmeApplet.getMolecularAreaGraphicsString();
        divElement.children(".PolymerSVG").html(svgStr);
        // automatically generate child stochastic objects
        var stoObjCount = 0;
        var match, newIdx, newElement;
        while(match = stoObjPatt.exec(smilesStr) ) {
          stoObjCount++;
          newElement = $("#StoObjTemplate").clone();
          // make new object visible
          newElement.css("display","block");
          // assign address
          newIdx = divElement.find(".address").html() + String(stoObjCount);
          newElement.find(".address").html(newIdx);
          // check if StoObj is on left terminal
          if(match.index == 0) {
            newElement.children(".DescText").children(".leftEnd").html("1");
          } else {
            if(smilesStr.charAt(match.index-1)=='.') {
              newElement.children(".DescText").children(".leftEnd").html("1");
            }
          }
          // check if StoObj is on right terminal
          var rightIdx = match.index + match[0].length;
          if(rightIdx == smilesStr.length) {
            newElement.children(".DescText").children(".rightEnd").html("1");
          } else {
            if(smilesStr.charAt(rightIdx)=='.' || smilesStr.charAt(rightIdx)==')') {
              newElement.children(".DescText").children(".rightEnd").html("1");
            }
          }

          newElement.appendTo(divElement);
        }
      });

      $( "#BigSMILEScontainer" ).on("click",".proj",function( event ){
        // project molecular fragment to JSME editor
        var jme = $(this).parent().children(".PolymerHidden").html();
        jsmeApplet.readMolecule(jme);
      });

      $( "#BigSMILEScontainer" ).on("click",".clear",function( event ){
        // project molecular fragment to JSME editor
        var divElement = $(this).parent();
        clearPolymer(divElement);
      });

      function clearPolymer(divElement){
        divElement.children(".PolymerColoredSMILES").html("");
        divElement.children(".PolymerSMILES").html("");
        divElement.children(".PolymerHidden").html("");
        divElement.children(".PolymerSVG").html("");
        divElement.children(".StoObj").remove();
        divElement.children(".Polymer").remove();
      }

      $( "#displayPanel" ).on("click",".getStr",function( event ){
        var element = $("#rootPolymer");
        // reset error message panel
        $("#ErrMsg").val('');
        // get BigSmiles string
        var stringToShow = getBigSmilesObjStr(element);
        $("#BigSmiles").val(stringToShow);
      });

      function matchAndReplace(patt,BigSmilesStr,func){
        var n=0;
        var match, indices = [];
        var repStrs = [];
        while(match = patt.exec(BigSmilesStr) ) {
          n++;
          indices.push([match.index, match.index+match[0].length]);
          repStrs.push(func(n,match));
        }
        var i;
        for(i=n-1;i>=0;i--) {
          BigSmilesStr = BigSmilesStr.substr(0,indices[i][0]) + repStrs[i] + BigSmilesStr.substr(indices[i][1],BigSmilesStr.length+1);
        }
        return BigSmilesStr;
      }

      function correctBondDesc(BigSmilesStr){
        BigSmilesStr = matchAndReplace(bondDescPatt,BigSmilesStr,function(x,match){
          return match[1];
        });
        return BigSmilesStr;
      }

      function highlightStoObj(BigSmilesStr){
        BigSmilesStr = matchAndReplace(stoObjPatt,BigSmilesStr,function(x,match){
          return '<span class="redSpan">' + match[0] + '</span>';
        });
        return BigSmilesStr;
      }

      function cleanBigSmilesStr(BigSmilesStr){
        var spanPatt = /\<\/?span( class\=\"[a-zA-Z0-9]*\")?\>/g;
        BigSmilesStr = matchAndReplace(spanPatt,BigSmilesStr,function(x,match){
          return '';
        });
        return BigSmilesStr;
      }

      function getBigSmilesObjStr(localDivElement) {
        //var localDivElement = element;
        var BigSmilesStr = localDivElement.children(".PolymerSMILES").html();
        // search raw string to change [$] into $, etc.
        BigSmilesStr = correctBondDesc(BigSmilesStr);
        // substitute the stochastic objects
        var patt = /\[Z\:?[0-9]*\]/ig;
        BigSmilesStr = matchAndReplace(patt,BigSmilesStr,function(x,match){
          return getStoObjStr(localDivElement.children(".StoObj").eq(x-1));
        });
        //alert(BigSmilesStr);
        return BigSmilesStr;
      }

      function getStoObjStr(localDivElement) {
        //alert('stoObjCalled');
        //var localDivElement = element;
        var RepUnitElement = localDivElement.children(".RepeatUnit");
        var EndGrpElement = localDivElement.children(".EndGroup");
        var BigSmilesStr = "{";
        // get left bonding descriptor
        var leftDesc = localDivElement.children(".DescText").children(".leftDesc").val();
        if(leftDesc=="") {
          if(localDivElement.children(".DescText").children(".leftEnd")=='1'){
            // StoObj is left terminal, so possibly no left bond desc
          } else {
            // StoObj is not left terminal, left bond desc must be present
            var msg = "Stochastic Object \"" + localDivElement.children(".title").children(".address").html() + "\" is missing left bonding descriptor!";
            $("#ErrMsg").val( $("#ErrMsg").val() + msg + "\n" );
            //alert(msg);
          }
        } else {
          BigSmilesStr = BigSmilesStr + "[" + leftDesc + "]"
        }
        // get all repeat units
        var nUnit = parseInt(RepUnitElement.children(".count").html());
        //alert(element.prop("tagName"));
        var i;
        for(i=0;i<nUnit;i++) {
          if(i>0) {
            BigSmilesStr = BigSmilesStr + ',';
          }
          BigSmilesStr = BigSmilesStr + getBigSmilesObjStr(RepUnitElement.children(".Polymer").eq(i));
        }
        // get all end groups
        var nEnd = parseInt(EndGrpElement.children(".count").html());
        if(nEnd>0) {
          BigSmilesStr = BigSmilesStr + ';';
        }
        for(i=0;i<nEnd;i++) {
          if(i>0) {
            BigSmilesStr = BigSmilesStr + ',';
          }
          BigSmilesStr = BigSmilesStr + getBigSmilesObjStr(EndGrpElement.children(".Polymer").eq(i));
        }
        // get right bonding descriptor
        var rightDesc = localDivElement.children(".DescText").children(".rightDesc").val();
        if(rightDesc=="") {
          if(localDivElement.children(".DescText").children(".rightEnd")=='1'){
            // StoObj is right terminal, so possibly no right bond desc
          } else {
            // StoObj is not right terminal, right bond desc must be present
            var msg = "Stochastic Object \"" + localDivElement.children(".title").children(".address").html() + "\" is missing right bonding descriptor!";
            $("#ErrMsg").val( $("#ErrMsg").val() +  msg + "\n");
            //alert(msg);
          }
        } else {
          BigSmilesStr = BigSmilesStr + "[" + rightDesc + "]"
        }

        BigSmilesStr = BigSmilesStr + '}';

        return BigSmilesStr;
      }


    </script>



  </body>
</html>
